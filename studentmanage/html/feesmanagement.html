<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fees Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .table th { background: #343a40; color: white; position: sticky; top: 0; }
        .editable-cell { 
            border-bottom: 2px solid #6c757d;
            min-width: 80px;
            display: inline-block;
            padding: 2px 5px;
        }
        .editable-cell:focus { 
            outline: none;
            border-bottom: 2px solid #0d6efd;
            background-color: #f8f9fa;
        }
        .whatsapp-btn { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 4px; }
        .badge-grade { font-size: 0.8em; }
        .remaining-cell { font-weight: bold; color: #dc3545; }
        .nav-tabs .nav-link.active { font-weight: bold; background-color: white; border-bottom: 3px solid #0d6efd; }
        .table-responsive { max-height: 75vh; overflow-y: auto; }
        .summary-card {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-11th { border-left: 4px solid #0d6efd; background-color: #f8f9fa; }
        .summary-12th { border-left: 4px solid #198754; background-color: #f8f9fa; }
        .summary-value { font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h2 class="mb-4">Fees Management System</h2>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="summary-card summary-11th">
                    <h5><i class="bi bi-people-fill text-primary"></i> 11th Grade Summary</h5>
                    <div class="row mt-2">
                        <div class="col-4">
                            <div class="summary-value text-primary" id="11th-total">₹0</div>
                            <small>Total Fees</small>
                        </div>
                        <div class="col-4">
                            <div class="summary-value text-success" id="11th-paid">₹0</div>
                            <small>Paid</small>
                        </div>
                        <div class="col-4">
                            <div class="summary-value text-danger" id="11th-remaining">₹0</div>
                            <small>Remaining</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="summary-card summary-12th">
                    <h5><i class="bi bi-people-fill text-success"></i> 12th Grade Summary</h5>
                    <div class="row mt-2">
                        <div class="col-4">
                            <div class="summary-value text-primary" id="12th-total">₹0</div>
                            <small>Total Fees</small>
                        </div>
                        <div class="col-4">
                            <div class="summary-value text-success" id="12th-paid">₹0</div>
                            <small>Paid</small>
                        </div>
                        <div class="col-4">
                            <div class="summary-value text-danger" id="12th-remaining">₹0</div>
                            <small>Remaining</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="tab11th">11th Grade</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="tab12th">12th Grade</a>
            </li>
        </ul>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Student Name</th>
                        <th>Parent Info</th>
                        <th>Class</th>
                        <th>Total Fees (₹)</th>
                        <th>Paid Fees (₹)</th>
                        <th>Remaining (₹)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="feesTableBody">
                    <!-- Data will load here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpBNXPgfC8oKwH_hcESZd1OSjxkuZ3qP8",
            authDomain: "cmanagementweb-53319.firebaseapp.com",
            projectId: "cmanagementweb-53319",
            storageBucket: "cmanagementweb-53319.appspot.com",
            messagingSenderId: "98416562035",
            appId: "1:98416562035:web:f083d012b694d971d17f06",
            measurementId: "G-NG15WBG6EH"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentCollection = 'students_11th';
        let studentsData = {};
        let feesData = {};
        let gradeTotals = {
            '11th': { total: 0, paid: 0, remaining: 0 },
            '12th': { total: 0, paid: 0, remaining: 0 }
        };

        // Load data immediately
        loadAllData();

        async function loadAllData() {
            await loadStudents();
            await loadFees();
            renderTable();
            updateGradeTotals();
        }

        async function loadStudents() {
            const snapshot = await db.collection(currentCollection).get();
            studentsData = {};
            snapshot.forEach(doc => {
                studentsData[doc.id] = doc.data();
            });
        }

        async function loadFees() {
            const snapshot = await db.collection('fees').get();
            feesData = {};
            gradeTotals = {
                '11th': { total: 0, paid: 0, remaining: 0 },
                '12th': { total: 0, paid: 0, remaining: 0 }
            };
            
            snapshot.forEach(doc => {
                const feeData = doc.data();
                feesData[doc.id] = feeData;
                
                // Calculate grade totals
                const grade = currentCollection.includes('11') ? '11th' : '12th';
                if (grade === '11th' || grade === '12th') {
                    gradeTotals[grade].total += Number(feeData.total) || 0;
                    gradeTotals[grade].paid += Number(feeData.paid) || 0;
                    gradeTotals[grade].remaining = gradeTotals[grade].total - gradeTotals[grade].paid;
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('feesTableBody');
            tbody.innerHTML = '';
            
            let index = 1;
            for (const studentId in studentsData) {
                const student = studentsData[studentId];
                const fees = feesData[studentId] || { total: 0, paid: 0 };
                const remaining = fees.total - fees.paid;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index++}</td>
                    <td>${student.fullName || 'N/A'}</td>
                    <td>${student.parentName || 'N/A'} (${student.parentPhone || 'N/A'})</td>
                    <td><span class="badge badge-grade ${currentCollection.includes('11') ? 'bg-primary' : 'bg-success'}">
                        ${currentCollection.includes('11') ? '11th' : '12th'}
                    </span></td>
                    <td>
                        <span class="editable-cell" contenteditable data-field="total" data-id="${studentId}">
                            ${fees.total}
                        </span>
                    </td>
                    <td>
                        <span class="editable-cell" contenteditable data-field="paid" data-id="${studentId}">
                            ${fees.paid}
                        </span>
                    </td>
                    <td class="remaining-cell">${remaining}</td>
                    <td>
                        <button class="whatsapp-btn" onclick="sendReminder('${student.parentPhone}', ${remaining}, '${student.fullName}')">
                            <i class="bi bi-whatsapp"></i> Remind
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Add edit event listeners
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', updateFees);
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        async function updateFees(e) {
            const cell = e.target;
            const value = parseInt(cell.textContent) || 0;
            const field = cell.getAttribute('data-field');
            const studentId = cell.getAttribute('data-id');
            
            // Update local data first for instant response
            if (!feesData[studentId]) feesData[studentId] = { total: 0, paid: 0 };
            const oldValue = feesData[studentId][field] || 0;
            feesData[studentId][field] = value;
            
            // Update remaining in UI
            const row = cell.closest('tr');
            const total = feesData[studentId].total || 0;
            const paid = feesData[studentId].paid || 0;
            const remaining = total - paid;
            row.cells[6].textContent = remaining;
            
            // Update the WhatsApp button with new remaining amount
            const whatsappBtn = row.cells[7].querySelector('button');
            whatsappBtn.setAttribute('onclick', `sendReminder('${studentsData[studentId].parentPhone}', ${remaining}, '${studentsData[studentId].fullName}')`);
            
            // Save to Firebase
            try {
                await db.collection('fees').doc(studentId).set({
                    total: total,
                    paid: paid,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update grade totals
                const grade = currentCollection.includes('11') ? '11th' : '12th';
                const difference = value - oldValue;
                
                if (field === 'total') {
                    gradeTotals[grade].total += difference;
                    gradeTotals[grade].remaining += difference;
                } else if (field === 'paid') {
                    gradeTotals[grade].paid += difference;
                    gradeTotals[grade].remaining -= difference;
                }
                
                updateGradeTotalsUI();
                
            } catch (error) {
                console.error("Error updating fees:", error);
                alert("Failed to save. Please try again.");
                // Revert UI if save fails
                cell.textContent = oldValue;
                feesData[studentId][field] = oldValue;
                row.cells[6].textContent = (feesData[studentId].total || 0) - (feesData[studentId].paid || 0);
            }
        }

        function updateGradeTotals() {
            // Recalculate totals from all fees data
            gradeTotals = {
                '11th': { total: 0, paid: 0, remaining: 0 },
                '12th': { total: 0, paid: 0, remaining: 0 }
            };
            
            for (const studentId in feesData) {
                const feeData = feesData[studentId];
                const grade = studentsData[studentId] ? (currentCollection.includes('11') ? '11th' : '12th') : null;
                
                if (grade) {
                    gradeTotals[grade].total += Number(feeData.total) || 0;
                    gradeTotals[grade].paid += Number(feeData.paid) || 0;
                    gradeTotals[grade].remaining = gradeTotals[grade].total - gradeTotals[grade].paid;
                }
            }
            
            updateGradeTotalsUI();
        }

        function updateGradeTotalsUI() {
            // Update 11th grade totals
            document.getElementById('11th-total').textContent = `₹${gradeTotals['11th'].total.toLocaleString()}`;
            document.getElementById('11th-paid').textContent = `₹${gradeTotals['11th'].paid.toLocaleString()}`;
            document.getElementById('11th-remaining').textContent = `₹${gradeTotals['11th'].remaining.toLocaleString()}`;
            
            // Update 12th grade totals
            document.getElementById('12th-total').textContent = `₹${gradeTotals['12th'].total.toLocaleString()}`;
            document.getElementById('12th-paid').textContent = `₹${gradeTotals['12th'].paid.toLocaleString()}`;
            document.getElementById('12th-remaining').textContent = `₹${gradeTotals['12th'].remaining.toLocaleString()}`;
        }

        function sendReminder(phone, amount, name) {
            // Clean phone number (remove all non-digit characters)
            const cleanPhone = phone ? phone.replace(/\D/g, '') : '';
            
            if (!cleanPhone || cleanPhone.length < 10) {
                alert("Invalid or missing parent phone number!");
                return;
            }
            
            const message = `Dear Parent,\n\nThis is a reminder that the remaining fees for ${name || 'your ward'} is ₹${amount}.\n\nPlease make the payment at your earliest convenience.\n\nThank you,\n[ACC]`;
            const whatsappUrl = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Tab switching
        document.getElementById('tab11th').addEventListener('click', async () => {
            currentCollection = 'students_11th';
            document.getElementById('tab11th').classList.add('active');
            document.getElementById('tab12th').classList.remove('active');
            await loadStudents();
            renderTable();
            updateGradeTotals();
        });

        document.getElementById('tab12th').addEventListener('click', async () => {
            currentCollection = 'students_12th';
            document.getElementById('tab12th').classList.add('active');
            document.getElementById('tab11th').classList.remove('active');
            await loadStudents();
            renderTable();
            updateGradeTotals();
        });
    </script>
</body>
</html>